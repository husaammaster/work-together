name: work-together
services:
  couchdb:
    image: apache/couchdb:latest
    environment:
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - COUCHDB_LOG_LEVEL=warn
    ports:
      - "5984:5984"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://couchdb:5984/"]
      interval: 2s
      timeout: 5s
      retries: 3

  backend:
    build: .
    image: husam/wt-backend
    command: npm run dev
    develop:
      watch:
        - action: sync
          path: .
          target: /app
          ignore:
            - node_modules/
            - react_app/
            - .git/
            - .DS_Store
        - action: rebuild
          path: package*.json
    env_file:
      - ./.env
    ports:
      - "80:80"
    depends_on:
      couchdb:
        condition: service_healthy

  react-build-launch:
    build: ./react_app
    image: husam/wt-react-build-launch
    command: npm run dev -- --host
    env_file:
      - ./react_app/.env.docker
    develop:
      watch:
        - action: sync
          path: ./react_app
          target: /app
          ignore:
            - node_modules/
            - dist/
            - .DS_Store
        - action: rebuild
          path: ./react_app/package*.json
    ports:
      - "5174:5173"
